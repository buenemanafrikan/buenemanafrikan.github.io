<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Stone Spiral AR – iOS (AR.js)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      overflow: hidden;
    }
    header {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.6);
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      z-index: 20;
      text-align: center;
      max-width: 90vw;
    }
    #debug {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      max-height: 35vh;
      overflow-y: auto;
      font-size: 10px;
      background: rgba(0, 0, 0, 0.7);
      padding: 4px 6px;
      z-index: 30;
      white-space: pre-wrap;
    }
    a-scene {
      width: 100vw;
      height: 100vh;
    }
  </style>

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.3/aframe/build/aframe-ar.js"></script>
</head>
<body>
  <header>
    Halte die Kamera auf den Hiro-Marker (schwarz-weißes Block-Muster), dann sollte der gelbe Würfel + Strudel erscheinen.
  </header>
  <div id="debug">[debug] Seite geladen…</div>

  <!-- AR.js Szene -->
  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true; antialias: true; alpha: true;"
    arjs="sourceType: webcam; debugUIEnabled: true;"
  >
    <!-- Marker: Standard „hiro“ mit Events -->
    <a-marker
      preset="hiro"
      emitevents="true"
      id="hiroMarker"
      spiral-stones
    >
      <!-- Root für A-Frame-Entitäten (falls du später willst) -->
      <a-entity id="spiral-root-entity"></a-entity>
    </a-marker>

    <!-- Standard-Kamera -->
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // ---------- Debug-Overlay ----------
    const debugEl = document.getElementById('debug');
    function logDebug(msg) {
      console.log('[iOS AR]', msg);
      if (!debugEl) return;
      const ts = new Date().toISOString().substr(11, 8);
      debugEl.textContent += '\n[' + ts + '] ' + msg;
      debugEl.scrollTop = debugEl.scrollHeight;
    }

    logDebug('AFRAME vorhanden? ' + !!window.AFRAME);
    // -----------------------------------

    // ---------- Strudel + Debug-Würfel ----------
    AFRAME.registerComponent('spiral-stones', {
      schema: {},

      init: function () {
        logDebug('spiral-stones.init() aufgerufen');

        // Root-3D-Objekt, hängt am Marker
        this.root = new THREE.Group();
        this.el.object3D.add(this.root);

        this.stones = [];

        // TEST: feste Anzahl an Steinen (Später = stoneCount aus API)
        const stoneCount = 80;
        logDebug('Erzeuge Strudel mit stoneCount=' + stoneCount);

        const angleStepDeg = 15;
        const radiusStep = 0.03;
        const randomHeight = 0.01;

        const geom = new THREE.BoxGeometry(0.04, 0.025, 0.06);
        const mat = new THREE.MeshStandardMaterial({
          color: 0xcccccc,
          roughness: 0.9,
          metalness: 0.1
        });

        let angleRad = 0;
        let radius = 0;
        const angleStepRad = (angleStepDeg * Math.PI) / 180;

        for (let i = 0; i < stoneCount; i++) {
          const x = Math.cos(angleRad) * radius;
          const z = Math.sin(angleRad) * radius;
          const y = (Math.random() - 0.5) * 2 * randomHeight;

          const stone = new THREE.Mesh(geom, mat);
          stone.position.set(x, y, z);
          stone.rotation.y = (Math.random() - 0.5) * Math.PI;

          stone.userData.baseAngle = angleRad;
          stone.userData.radius = radius;
          stone.userData.baseHeight = y;

          this.root.add(stone);
          this.stones.push(stone);

          angleRad += angleStepRad;
          radius += radiusStep;
        }

        // fetter gelber Debug-Würfel mitten auf dem Marker,
        // damit du SOFORT siehst, ob der Marker überhaupt tracked:
        const debugGeom = new THREE.BoxGeometry(0.2, 0.2, 0.2);
        const debugMat = new THREE.MeshStandardMaterial({
          color: 0xffff00
        });
        const debugCube = new THREE.Mesh(debugGeom, debugMat);
        debugCube.position.set(0, 0.1, 0); // leicht über dem Marker
        this.root.add(debugCube);

        // Strudel verkleinern, damit er nicht zu riesig ist
        this.root.scale.set(0.3, 0.3, 0.3);

        logDebug('Strudel erstellt, Stones=' + this.stones.length);
      },

      tick: function (time, timeDelta) {
        if (!this.stones || this.stones.length === 0) return;

        const t = time / 1000;

        this.stones.forEach((stone, index) => {
          const baseAngle = stone.userData.baseAngle;
          const radius = stone.userData.radius;
          const baseHeight = stone.userData.baseHeight;

          const speed = 0.2 + radius * 0.1;
          const angle = baseAngle + t * speed;

          const x = Math.cos(angle) * radius;
          const z = Math.sin(angle) * radius;
          const y = baseHeight + Math.sin(t * 2 + index * 0.3) * 0.01;

          stone.position.set(x, y, z);
          stone.rotation.y += 0.01;
        });
      }
    });

    // Marker-Events loggen
    window.addEventListener('load', () => {
      logDebug('window.load');

      const marker = document.getElementById('hiroMarker');
      if (!marker) {
        logDebug('Kein #hiroMarker gefunden!');
        return;
      }

      marker.addEventListener('markerFound', () => {
        logDebug('markerFound (Hiro erkannt)');
      });

      marker.addEventListener('markerLost', () => {
        logDebug('markerLost (Hiro verloren)');
      });

      logDebug('Marker-Events registriert.');
    });

    // A-Frame Scene-Event
    document.querySelector('a-scene')?.addEventListener('loaded', () => {
      logDebug('a-scene loaded');
    });
  </script>
</body>
</html>











