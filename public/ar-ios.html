<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Stone Spiral AR – iOS (Marker)</title>
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
  />

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    header {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      z-index: 5;
      text-align: center;
      max-width: 90vw;
    }

    a-scene {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 0;
    }
  </style>

  <!-- A-Frame (Version, die gut mit AR.js harmoniert) -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <!-- AR.js für A-Frame (Marker-Tracking, kein WebXR) -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
</head>
<body>
  <header>
    Halte die Kamera auf den Hiro-Marker (schwarz-weißes Block-Muster),
    dann erscheint der Steine-Strudel.
  </header>

  <!-- AR.js Szene -->
  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    arjs="sourceType: webcam; debugUIEnabled: false;"
    renderer="alpha: true; antialias: true;"
  >
    <!-- Licht -->
    <a-entity
      light="type: hemisphere; intensity: 1; color: #ffffff; groundColor: #444444"
    ></a-entity>
    <a-entity
      light="type: directional; intensity: 0.7"
      position="1 2 1"
    ></a-entity>

    <!-- Marker: Hiro -->
    <a-marker preset="hiro">
      <!-- Fallback: ein gelber Würfel, damit du sicher was siehst -->
      <a-box
        position="0 0.5 0"
        depth="0.4"
        height="0.4"
        width="0.4"
        color="#ffaa00"
        opacity="0.4"
      ></a-box>

      <!-- Hier hängt unser Strudel dran -->
      <a-entity id="spiral-root" spiral-stones></a-entity>
    </a-marker>

    <!-- Kamera -->
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // A-Frame Komponente für den Steine-Strudel
    AFRAME.registerComponent('spiral-stones', {
      init: function () {
        this.stones = [];
        this.loaded = false;
        this.createSpiralFromApi();
      },

      // Holt stoneCount vom Backend (gleiche API wie Android) und baut den Strudel
      createSpiralFromApi: async function () {
        const root = this.el.object3D;
        let stoneCount = 60; // Fallback

        try {
          const res = await fetch('/api/stone-count', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason: 'ios-ar-start' })
          });

          if (res.ok) {
            const data = await res.json();
            if (typeof data.stoneCount === 'number') {
              stoneCount = data.stoneCount;
            }
            console.log('[iOS AR] stoneCount aus API =', stoneCount);
          } else {
            console.warn('[iOS AR] /api/stone-count HTTP', res.status);
          }
        } catch (e) {
          console.error('[iOS AR] Fehler bei fetch /api/stone-count:', e);
        }

        // Begrenzen, damit iOS nicht abraucht
        stoneCount = Math.max(1, Math.min(stoneCount, 400));

        const angleStepDeg = 15;
        const radiusStep = 0.03;
        const randomHeight = 0.01;

        // THREE kommt von A-Frame / AR.js global rein
        const geom = new THREE.BoxGeometry(0.04, 0.025, 0.06);
        const mat = new THREE.MeshStandardMaterial({
          color: 0x777777,
          roughness: 0.9,
          metalness: 0.1
        });

        let angleRad = 0;
        let radius = 0;
        const angleStepRad = THREE.MathUtils.degToRad(angleStepDeg);

        for (let i = 0; i < stoneCount; i++) {
          const x = Math.cos(angleRad) * radius;
          const z = Math.sin(angleRad) * radius;
          const y = (Math.random() - 0.5) * 2 * randomHeight;

          const stone = new THREE.Mesh(geom, mat);

          stone.position.set(x, y, z);
          stone.rotation.y = (Math.random() - 0.5) * Math.PI;

          stone.userData.baseAngle = angleRad;
          stone.userData.radius = radius;
          stone.userData.baseHeight = y;

          root.add(stone);
          this.stones.push(stone);

          angleRad += angleStepRad;
          radius += radiusStep;
        }

        this.loaded = true;
        console.log(
          '[iOS AR] Spiral erstellt mit',
          this.stones.length,
          'Steinen.'
        );
      },

      // Animation (wie Android – Strudel dreht sich & wabert)
      tick: function (time, timeDelta) {
        if (!this.loaded || !this.stones || this.stones.length === 0) return;

        const t = time / 1000;

        this.stones.forEach((stone, index) => {
          const baseAngle = stone.userData.baseAngle;
          const radius = stone.userData.radius;
          const baseHeight = stone.userData.baseHeight;

          const speed = 0.2 + radius * 0.1;
          const angle = baseAngle + t * speed;

          const x = Math.cos(angle) * radius;
          const z = Math.sin(angle) * radius;
          const y =
            baseHeight + Math.sin(t * 2 + index * 0.3) * 0.01;

          stone.position.set(x, y, z);
          stone.rotation.y += 0.01;
        });
      }
    });
  </script>
</body>
</html>









