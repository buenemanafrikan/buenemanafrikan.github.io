<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Stone Spiral AR – iOS (Marker)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #000;
      color: #fff;
    }

    #info {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.6);
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 12px;
      z-index: 10;
      max-width: 90vw;
      text-align: center;
    }
  </style>

  <!-- A-Frame + AR.js (kostenlos, kein App-Key) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ar.js@3.4.6/aframe/build/aframe-ar.min.js"></script>
</head>
<body>
  <div id="info">
    Halte die Kamera auf den <b>Hiro-Marker</b> (Schwarz-Weiß-Block-Muster), dann erscheint der Steine-Strudel.
  </div>

  <!-- AR.js Szene -->
  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true; antialias: true; alpha: true"
    arjs="sourceType: webcam; debugUIEnabled: false;"
  >
    <!-- Dein Steinmodell (Stone.glb) – liegt im gleichen Ordner wie bei Android: ./assets/models/Stone.glb -->
    <a-assets>
      <a-asset-item id="stoneModel" src="./assets/models/Stone.glb"></a-asset-item>
    </a-assets>

    <!-- Marker: wir nutzen das Standard-Hiro-Muster -->
    <a-marker id="marker" preset="hiro">
      <!-- Hier hängen wir den Strudel dran -->
      <a-entity id="strudelRoot" scale="0.3 0.3 0.3"></a-entity>
    </a-marker>

    <!-- Kamera -->
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    (function () {
      // Gleiche API wie Android: POST /api/stone-count
      const STONECOUNT_ENDPOINT = '/api/stone-count';

      const marker = document.getElementById('marker');
      const root   = document.getElementById('strudelRoot');

      let stoneCountForSpiral = 60;  // Default
      let strudelCreated = false;    // nur einmal bauen

      // 1) Counter erhöhen + aktuellen stoneCount vom Backend holen
      async function incrementAndLoadStoneCount() {
        try {
          const res = await fetch(STONECOUNT_ENDPOINT, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ reason: 'ios-marker-ar-start' })
          });

          if (!res.ok) {
            console.error('[iOS] /api/stone-count Status:', res.status);
            return;
          }

          const data = await res.json();
          if (typeof data.stoneCount === 'number') {
            stoneCountForSpiral = data.stoneCount;
          }

          console.log('[iOS] stoneCount vom Server:', stoneCountForSpiral);
        } catch (err) {
          console.error('[iOS] Fehler bei /api/stone-count:', err);
        }
      }

      // 2) Strudel bauen (Spirale aus Stone.glb-Klonen)
      function createStrudel() {
        if (strudelCreated) return;
        strudelCreated = true;

        // 1:1 mit Deinem globalen Counter, aber etwas gecappt
        const stoneCount = Math.max(1, Math.min(stoneCountForSpiral, 500));
        console.log('[iOS] Strudel wird gebaut mit', stoneCount, 'Steinen.');

        const angleStepDeg = 15;
        const radiusStep   = 0.03;
        const randomHeight = 0.01;

        let angleRad = 0;
        let radius   = 0;
        const angleStepRad = angleStepDeg * Math.PI / 180;

        for (let i = 0; i < stoneCount; i++) {
          const x = Math.cos(angleRad) * radius;
          const z = Math.sin(angleRad) * radius;
          const y = (Math.random() - 0.5) * 2 * randomHeight;

          const stone = document.createElement('a-entity');
          stone.setAttribute('gltf-model', '#stoneModel');
          stone.setAttribute('position', x + ' ' + y + ' ' + z);
          stone.setAttribute('rotation', '0 ' + (Math.random() * 360) + ' 0');

          root.appendChild(stone);

          angleRad += angleStepRad;
          radius   += radiusStep;
        }

        // kompletter Strudel rotiert → "wirbelnder" Effekt wie auf Android
        root.setAttribute(
          'animation',
          'property: rotation; to: 0 360 0; loop: true; dur: 15000; easing: linear'
        );
      }

      // 3) Wenn der Marker das erste Mal erkannt wird → Counter++ & Strudel bauen
      marker.addEventListener('markerFound', () => {
        if (strudelCreated) return;

        console.log('[iOS] Marker gefunden → Counter++ & Strudel aufbauen');
        incrementAndLoadStoneCount().then(createStrudel);
      });
    })();
  </script>
</body>
</html>





